
<% layout("./layouts/boilerplate") -%>


<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<p class="text-3xl font-bold text-indigo-700 text-center mt-4 mb-6 border-b pb-2 w-fit mx-auto">
  🏡 Listing
</p>

<div class="max-w-4xl mx-auto bg-white rounded-2xl overflow-hidden shadow-lg">
  <img 
    src="<%= listing.image.url %>" 
    alt="<%= listing.title %>" 
    class="w-full h-60 sm:h-96 object-cover"
  />

  <!-- Listing Info -->
  <div class="p-4 sm:p-6 text-gray-800 space-y-4 text-base sm:text-lg">
    <h2 class="text-2xl font-bold text-center text-gray-900"><%= listing.title %></h2>
    
     <div class="flex items-center bg-white shadow-md rounded-xl p-4 max-w-xs hover:shadow-lg transition">
    <img src="<%= listing.owner.avatar || '/images/default-avatar.png' %>" 
          
         class="w-12 h-12 rounded-full object-cover border-2 border-gray-200 mr-4">
    <div>
        <p class="text-sm text-gray-400"> <i>Hosted By</i></p>
        <p class="text-lg font-semibold text-gray-800"><%= listing.owner.username %></p>
    </div>
</div>
    <p><span class="font-semibold text-gray-600">📝 Description:</span> <%= listing.description %></p>
    <p>
  <span class="font-semibold text-gray-700">💰 Price:</span> 
  <span class="text-green-600 font-semibold">
    ₹<%= listing.price ? Number(listing.price).toLocaleString("en-IN") : "N/A" %>
  </span>
</p>

<div class="flex items-center gap-1 font-semibold">
   <i class="fa-solid fa-location-dot" style="color: #74C0FC;"></i>
    <p class="flex items-center ">

        <%= listing.location %>,
    </p>
    <p class="flex items-center ">
      
        <%= listing.country %>
    </p>
</div>




<% if (listing.geometry) { %>
  <div id="map" style="height: 400px;" class="rounded-lg mx-4 sm:mx-6 my-6 border border-gray-300 shadow-md"></div>
<% } %>


  <!-- Buttons -->
   <% if(currUser && currUser._id.equals(listing.owner._id)){ %>
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 px-4 py-4 border-t">
    <a 
      href="/listings/<%= listing._id %>/edit"
      class="w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-6 py-2 rounded-lg text-center"
    >
      ✏️ Edit
    </a>

    <form 
      action="/listings/<%= listing._id %>?_method=DELETE" 
      method="POST" 
      class="w-full sm:w-auto"
    >
      <button
        type="submit"
        class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold px-6 py-2 rounded-lg"
      >
        🗑️ Delete
      </button>
    </form>
  </div>
   <% } %>
 
   <% if(currUser) { %>
  <h2 class="text-xl sm:text-3xl  text-gray-800 mt-8  relative inline-block">
  <span class="bg-gradient-to-r from-red-500 to-indigo-600 bg-clip-text text-transparent">
    Add a Review
  </span>

</h2>
  <form 
    id="reviewForm" 
    action="/listings/<%= listing._id %>/reviews" 
    method="POST" 
    class="max-w-2xl mx-auto bg-gray-50 p-6 rounded-2xl mt-8"
    novalidate
  >
    
    <div class="mb-4">
      <label for="rating" class="block text-gray-700 font-medium mb-2">Rating</label>
      
   <div class="flex items-center space-x-1">
  <!-- 1 Star -->
  <input type="radio" id="star1" name="Review[rating]" value="1" class="hidden peer/one" />
  <label for="star1" class="cursor-pointer text-gray-300 hover:bg-gradient-to-r hover:from-yellow-400 hover:to-yellow-600 hover:text-transparent hover:bg-clip-text peer-checked/one:bg-gradient-to-r peer-checked/one:from-yellow-400 peer-checked/one:to-yellow-600 peer-checked/one:text-transparent peer-checked/one:bg-clip-text text-3xl transition-all duration-300 ease-in-out">★</label>

  <!-- 2 Star -->
  <input type="radio" id="star2" name="Review[rating]" value="2" class="hidden peer/two" />
  <label for="star2" class="cursor-pointer text-gray-300 hover:bg-gradient-to-r hover:from-yellow-400 hover:to-yellow-600 hover:text-transparent hover:bg-clip-text peer-checked/two:bg-gradient-to-r peer-checked/two:from-yellow-400 peer-checked/two:to-yellow-600 peer-checked/two:text-transparent peer-checked/two:bg-clip-text text-3xl transition-all duration-300 ease-in-out">★</label>

  <!-- 3 Star -->
  <input type="radio" id="star3" name="Review[rating]" value="3" class="hidden peer/three" />
  <label for="star3" class="cursor-pointer text-gray-300 hover:bg-gradient-to-r hover:from-yellow-400 hover:to-yellow-600 hover:text-transparent hover:bg-clip-text peer-checked/three:bg-gradient-to-r peer-checked/three:from-yellow-400 peer-checked/three:to-yellow-600 peer-checked/three:text-transparent peer-checked/three:bg-clip-text text-3xl transition-all duration-300 ease-in-out">★</label>

  <!-- 4 Star -->
  <input type="radio" id="star4" name="Review[rating]" value="4" class="hidden peer/four" />
  <label for="star4" class="cursor-pointer text-gray-300 hover:bg-gradient-to-r hover:from-yellow-400 hover:to-yellow-600 hover:text-transparent hover:bg-clip-text peer-checked/four:bg-gradient-to-r peer-checked/four:from-yellow-400 peer-checked/four:to-yellow-600 peer-checked/four:text-transparent peer-checked/four:bg-clip-text text-3xl transition-all duration-300 ease-in-out">★</label>

  <!-- 5 Star -->
  <input type="radio" id="star5" name="Review[rating]" value="5" class="hidden peer/five" />
  <label for="star5" class="cursor-pointer text-gray-300 hover:bg-gradient-to-r hover:from-yellow-400 hover:to-yellow-600 hover:text-transparent hover:bg-clip-text peer-checked/five:bg-gradient-to-r peer-checked/five:from-yellow-400 peer-checked/five:to-yellow-600 peer-checked/five:text-transparent peer-checked/five:bg-clip-text text-3xl transition-all duration-300 ease-in-out">★</label>
</div>


    </div>

    <div class="mb-4">
      <label for="comment" class="block text-gray-700 font-medium mb-2">Comment</label>
      <textarea 
        name="Review[comment]" 
        id="comment" 
        rows="4" 
        required 
        placeholder="Write your thoughts..." 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
      ></textarea>
      <p class="comment-error text-red-500 text-sm mt-1 hidden">Comment is required.</p>
    </div>

    <div class="text-right">
      <button 
        type="submit" 
        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-300"
      >
        Submit Review
      </button>
    </div>
  </form>
</div>
<% } %>




<% if (listing.reviews.length > 0) { %>
  <h2 class="font-semibold text-2xl ml-3 text-gray-800 border-b pb-3  mb-6 ">
  Recent reviews
</h2>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 px-4">
    
    <% listing.reviews.forEach(review => { %>
      <div class="bg-white shadow-sm rounded-2xl p-5 border border-gray-100 hover:shadow-lg transition duration-300 relative">

        <!-- 🗑 Delete Button --> 
         <form 
          action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" 
          method="POST" 
          class="absolute top-3 right-3"
          onsubmit="return confirm('Are you sure you want to delete this review?')"
        >
          <button 
            type="submit" 
            class="flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 text-xs font-medium rounded-full hover:bg-red-100 transition duration-200"
            title="Delete Review"
          >
            <svg xmlns="https://www.w3.org/2000/svg" class="w-4 h-4 " fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            Delete
          </button>
        </form> 

         <p class="text-gray-800 text-lg font-semibold mt-1">@<%= review.author.username %></p>
           <p class="text-xs text-gray-400 mb-2"><%= review.createdAt.toDateString() %></p>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2 pr-6">
          

          <!-- Stars -->
          <div class="flex items-center space-x-1">
            <% for(let i = 1; i <= 5; i++) { %>
              <% if(i <= review.rating) { %>
                <!-- Filled Star -->
                <svg class="w-5 h-5 text-yellow-400 fill-current" xmlns="https://www.w3.org/2000/svg" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.36a1 1 0 00.95.69h3.537c.969 0 1.371 1.24.588 1.81l-2.86 2.078a1 1 0 00-.364 1.118l1.09 3.36c.3.921-.755 1.688-1.54 1.118l-2.86-2.078a1 1 0 00-1.175 0l-2.86 2.078c-.785.57-1.84-.197-1.54-1.118l1.09-3.36a1 1 0 00-.364-1.118L2.98 8.787c-.783-.57-.38-1.81.588-1.81h3.537a1 1 0 00.95-.69l1.09-3.36z"/>
                </svg>
              <% } else { %>
                <!-- Empty Star -->
                <svg class="w-5 h-5 text-gray-300" xmlns="https://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                  <path stroke="currentColor" stroke-width="2" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.36a1 1 0 00.95.69h3.537c.969 0 1.371 1.24.588 1.81l-2.86 2.078a1 1 0 00-.364 1.118l1.09 3.36c.3.921-.755 1.688-1.54 1.118l-2.86-2.078a1 1 0 00-1.175 0l-2.86 2.078c-.785.57-1.84-.197-1.54-1.118l1.09-3.36a1 1 0 00-.364-1.118L2.98 8.787c-.783-.57-.38-1.81.588-1.81h3.537a1 1 0 00.95-.69l1.09-3.36z"/>
                </svg>
              <% } %>
            <% } %>
          
          </div>
        </div>

        <!-- Comment  -->
         <p class="text-gray-700 text-sm sm:text-base leading-relaxed">
          <%= review.comment %>
        </p>
      </div>
    <% }) %>
  </div>
<% } else { %>
  <p class="text-gray-500 text-center mt-4">No reviews yet. Be the first to review!</p>
<% } %> 

               



<% if (listing.geometry) { %>
<script>
  // Check if L is loaded
  if (typeof L !== "undefined") {

    const coordinates = <%- JSON.stringify(listing.geometry.coordinates) %>;
    const map = L.map('map', {
      scrollWheelZoom: false, // Disable scroll zoom
      gestureHandling: true   // Optional: Better mobile handling (requires leaflet-gesture-handling plugin)
    }).setView([coordinates[1], coordinates[0]], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.marker([coordinates[1], coordinates[0]])
      .addTo(map)
      .bindPopup("<%= listing.title %>")
      .openPopup();

    // Optional: Enable zoom only when user clicks on map
    map.on('click', function () {
      map.scrollWheelZoom.enable();
    });
  } else {
    console.error("❌ Leaflet L not loaded");
  }
</script>
<% } %>
 


 